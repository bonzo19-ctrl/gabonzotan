<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow, noarchive">
    <title>GaBonzoTan v.1.8.19</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: #121212; --card-dark: #1e1e1e; --accent-gold: #f1c40f;
            --ai-purple: #9b59b6; --text-dim: #b3b3b3; --insight-blue: #3498db; --red: #e74c3c;
            --about-green: #27ae60;
            --improvement-green: #1abc9c;
            --options-pink: #e056fd;
        }
        body { background-color: var(--bg-dark); color: #ecf0f1; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        .app-logo { 
            width: 100%; 
            max-width: 280px; 
            height: auto; 
            margin: 0 auto 10px auto; 
            display: block;
        }
        .logo-container { text-align: center; margin-bottom: 25px; }

        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #lock-screen .warning-msg { font-style: italic; color: #666; font-size: 13px; margin-bottom: 25px; margin-top: -10px; }
        
        .login-box { display: flex; flex-direction: column; gap: 10px; width: 240px; }
        #lock-screen input { padding: 12px; border-radius: 5px; border: none; text-align: center; background: #1a1a1a; color: white; border: 1px solid #333; font-size: 16px; text-transform: lowercase; }
        #lock-screen .version-tag { margin-top: 60px; }
        
        #app-content { width: 100%; max-width: 500px; padding: 30px 20px; display: none; position: relative; }
        .version-tag { text-align: center; font-size: 10px; color: #555; margin-bottom: 25px; letter-spacing: 1px; margin-top: -15px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 13px; padding: 5px 10px; transition: 0.3s; white-space: nowrap; outline: none; }
        .tab-btn.active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }

        .add-game-btn { width: 100%; background: var(--accent-gold); color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px; font-size: 16px; }

        .history-item { background: var(--card-dark); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent-gold); position: relative; }
        .ai-win-card { border-left-color: var(--ai-purple); }
        .actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
        .action-btn { background: none; border: none; color: #444; cursor: pointer; font-size: 16px; transition: color 0.2s; }
        .chip { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 13px; margin-right: 8px; border: 1px solid transparent; display: inline-block; margin-top: 8px; }
        .winner-chip { border-color: var(--accent-gold); color: var(--accent-gold); font-weight: bold; }
        
        .map-info-label { font-size: 11px; color: var(--insight-blue); font-weight: bold; text-transform: uppercase; margin-top: 5px; display: block; border-left: 2px solid var(--insight-blue); padding-left: 6px; }
        
        .game-notes { font-size: 11px; color: #888; margin-top: 10px; font-style: italic; border-top: 1px solid #2a2a2a; padding-top: 8px; }
        .logged-meta { font-size: 9px; color: #888; margin-top: 8px; text-transform: uppercase; letter-spacing: 0.5px; }

        .h2h-tracker { text-align: center; font-style: italic; color: var(--ai-purple); font-size: 14px; margin: 10px 0; padding: 5px; }

        .app-footer { display: flex; justify-content: space-between; align-items: flex-start; margin-top: 15px; padding-top: 15px; border-top: 1px solid #222; gap: 10px; }
        .footer-btns { display: flex; flex-direction: row; gap: 6px; flex-wrap: wrap; flex: 1; }
        .footer-btns button { 
            padding: 4px 2px; 
            border-radius: 6px; 
            font-size: 7px; 
            cursor: pointer; 
            letter-spacing: 0.5px; 
            text-transform: uppercase; 
            white-space: normal; 
            flex: 1; 
            min-width: 55px; 
            min-height: 32px; 
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
        }
        
        .changelog-btn { background: #1e112a; color: var(--ai-purple); border: 1px solid var(--ai-purple); }
        .improvement-btn { background: #112a28; color: var(--improvement-green); border: 1px solid var(--improvement-green); }
        .logins-btn { background: #111a2a; color: var(--insight-blue); border: 1px solid var(--insight-blue); }
        .options-btn { background: #2a1125; color: var(--options-pink); border: 1px solid var(--options-pink); }
        .about-btn { background: #112a1a; color: var(--about-green); border: 1px solid var(--about-green); }

        .loggometer { width: 90px; background: #111; padding: 8px; border-radius: 8px; border: 1px solid #333; cursor: pointer; }
        .meter-dial { height: 6px; background: #222; border-radius: 5px; position: relative; overflow: hidden; margin: 4px 0; }
        .meter-needle { position: absolute; height: 100%; width: 4px; background: var(--accent-gold); left: 0%; transition: left 0.3s ease; }

        #modal, #improvement-modal, #logins-modal, #options-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 95%; max-width: 440px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        .row-entry { display: grid; grid-template-columns: 100px 1fr 60px; gap: 10px; margin-bottom: 12px; align-items: center; }
        select, input, textarea { background: #333; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        
        .required-star { color: var(--red); font-weight: bold; margin-left: 2px; }

        #easter-egg-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); display: none; justify-content: center; align-items: center; z-index: 10000; cursor: pointer; }
        #easter-egg-overlay img { max-width: 90%; max-height: 80%; border: 2px solid var(--accent-gold); box-shadow: 0 0 20px var(--accent-gold); border-radius: 10px; }

        .changelog-container { max-height: 480px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; scrollbar-width: thin; scrollbar-color: var(--ai-purple) #111; }
        .changelog-entry { margin-bottom: 25px; padding-left: 10px; border-left: 2px solid #333; }
        .changelog-ver { color: var(--accent-gold); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .changelog-list { list-style: none; padding: 0; margin: 0; font-size: 12px; color: var(--text-dim); }
        .changelog-list li { margin-bottom: 6px; position: relative; padding-left: 12px; line-height: 1.4; }
        .changelog-list li::before { content: "‚Ä¢"; position: absolute; left: 0; color: var(--insight-blue); }
        .back-nav-btn { width: auto; background: #1e112a; color: var(--ai-purple); border: solid 1px var(--ai-purple); padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; letter-spacing: 1px; display: block; margin: 0 auto; }

        .feedback-list, .login-list { margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; }
        .feedback-card, .login-card { background: #161616; padding: 10px; border-radius: 6px; margin-bottom: 10px; position: relative; }
        .feedback-card { border-left: 3px solid var(--improvement-green); }
        .login-card { border-left: 3px solid var(--insight-blue); display: flex; justify-content: space-between; align-items: center; }
        .feedback-text { font-size: 12px; color: #ddd; margin-bottom: 5px; white-space: pre-wrap; }
        .feedback-meta { font-size: 9px; color: #666; text-transform: uppercase; }
        .feedback-actions { position: absolute; top: 5px; right: 8px; display: flex; gap: 8px; }
        .login-user { font-weight: bold; color: var(--insight-blue); font-size: 13px; text-transform: uppercase; }
        .login-time { font-size: 10px; color: #666; }

        /* THE GHOSTLY LOGGO FLASH */
        #loggo-flash {
            position: fixed;
            inset: 0;
            z-index: 99999;
            pointer-events: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18vw;
            font-weight: 900;
            color: var(--red);
            opacity: 0;
            text-shadow: 0 0 30px rgba(231, 76, 60, 0.6);
            font-family: 'Arial Black', sans-serif;
            letter-spacing: 10px;
            user-select: none;
        }
    </style>
</head>
<body onload="checkSessionOnLoad()">

    <div id="loggo-flash">LOGGO</div>

    <div id="lock-screen">
        <div class="logo-container">
            <img src="https://raw.githubusercontent.com/bonzo19-ctrl/gabonzotan/refs/heads/main/gabonzotan2.png" alt="GaBonzoTan Logo" class="app-logo">
        </div>
        <div class="warning-msg">(If you're not Gabo or Nico, get the fuck out of here.)</div>
        <div class="login-box">
            <input type="text" id="user-name" placeholder="Name" autocomplete="off" onkeydown="if(event.key==='Enter') document.getElementById('pass-input').focus()">
            <input type="password" id="pass-input" placeholder="Password" onkeydown="if(event.key==='Enter') checkPass()">
            <button onclick="checkPass()" style="padding:10px 20px; background:var(--accent-gold); border:none; border-radius:4px; font-weight:bold; cursor:pointer">ENTER</button>
        </div>
        <div class="version-tag">STABLE RELEASE v.1.8.19</div>
    </div>

    <div id="app-content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div id="active-user-tag" onclick="triggerEasterEgg()" style="font-size: 10px; color: var(--accent-gold); font-weight: bold; text-transform: uppercase; cursor: pointer; user-select: none; padding: 5px;"></div>
            <button onclick="logout()" style="background:none; border:none; color:#555; font-size:10px; cursor:pointer">LOGOUT</button>
        </div>
        
        <div class="logo-container">
            <img src="https://raw.githubusercontent.com/bonzo19-ctrl/gabonzotan/refs/heads/main/gabonzotan2.png" alt="GaBonzoTan Logo" class="app-logo">
        </div>
        <div class="version-tag">STABLE RELEASE v.1.8.19</div>
        
        <div class="nav-tabs">
            <button id="t-history" class="tab-btn active" onclick="switchTab('history')">Game History</button>
            <button id="t-insights" class="tab-btn" onclick="switchTab('insights')">Player Stats</button>
            <button id="t-ai" class="tab-btn" onclick="switchTab('ai')">AI Stats</button>
        </div>

        <div id="action-area"><button class="add-game-btn" onclick="openModal()">+ ADD NEW GAME</button></div>
        <div id="main-view">Connecting...</div>

        <div class="app-footer">
            <div class="footer-btns">
                <button class="changelog-btn" onclick="switchTab('changelog')">CHANGELOGGO</button>
                <button class="improvement-btn" onclick="openImprovementModal()">IMPROVEMENTS</button>
                <button class="logins-btn" onclick="openLoginsModal()">LOGINS</button>
                <button class="options-btn" onclick="openOptionsModal()">MORE OPTIONS</button>
                <button class="about-btn" onclick="alert('Catan Tracker for Bonzito and Gabito. Rar.')">ABOUT</button>
            </div>
            <div class="loggometer" onclick="alert('RAAAAAAAR')">
                <div style="font-size:7px; color:#666; text-align:center">LOGGOMETER‚Ñ¢</div>
                <div class="meter-dial"><div id="needle" class="meter-needle"></div></div>
                <div id="meter-val" style="font-size:8px; color:#aaa; text-align:center; font-family:monospace">0.0% LOGGO</div>
            </div>
        </div>
    </div>

    <div id="easter-egg-overlay" onclick="this.style.display='none'">
        <img id="egg-img" src="" alt="Secret Easter Egg">
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:var(--accent-gold)">Add A Game</h3>
            <input type="hidden" id="editing-id">
            <div style="display:grid; grid-template-columns:2fr 1fr 1fr; gap:10px; margin-bottom:15px">
                <div>
                    <label style="font-size:9px; color:#666">DATE<span class="required-star">*</span></label>
                    <input type="date" id="game-date">
                </div>
                <div>
                    <label style="font-size:9px; color:#666">VP<span class="required-star">*</span></label>
                    <input type="number" id="winning-vp" placeholder="VP" value="10">
                </div>
                <div>
                    <label style="font-size:9px; color:#666">GAME #<span class="required-star">*</span></label>
                    <input type="number" id="game-number" value="1" min="1">
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-size:10px; color:#666; display:block; margin-bottom:4px">SELECT MAP<span class="required-star">*</span></label>
                <select id="game-map">
                    <option value="">(No Map Selected)</option>
                    <option value="The First Island">The First Island</option>
                    <option value="The First Island (5-6)">The First Island (5-6)</option>
                    <option value="Ore For Wool">Ore For Wool</option>
                    <option value="The Harbormaster">The Harbormaster</option>
                </select>
            </div>
            
            <div id="player-rows-header" style="display: grid; grid-template-columns: 100px 1fr 60px; gap: 10px; margin-bottom: 5px; align-items: center;">
                <span style="font-size: 10px; color: #666; text-transform: uppercase;">Player<span class="required-star">*</span></span>
                <span></span>
                <span style="font-size: 10px; color: var(--accent-gold); text-transform: uppercase; text-align: center; font-weight: bold; white-space: nowrap;">Won By<span class="required-star">*</span></span>
            </div>

            <div id="player-rows"></div>
            <div style="display:grid; grid-template-columns:1fr 60px; gap:10px; align-items:center; margin-top:10px">
                <span style="font-size: 13px; color: var(--text-dim);">Include AI Player</span>
                <input type="checkbox" id="ai-toggle" onchange="toggleAIRow()">
            </div>
            <div id="ai-row" class="row-entry" style="display:none; margin-top:10px; color:var(--ai-purple)">
                <span style="font-weight:bold">AI Bot</span><span></span><div style="text-align:center"><input type="radio" name="winner" id="ai-win-radio" value="AI"></div>
            </div>
            <div style="margin-top:15px">
                <textarea id="game-notes" placeholder="Notes (optional session details...)"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button onclick="closeModal()" style="flex:1; background:#444; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer">Cancel</button>
                <button onclick="saveGame()" style="flex:1; background:var(--accent-gold); color:black; border:none; padding:12px; border-radius:4px; font-weight:bold; cursor:pointer">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="improvement-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--improvement-green)">Improvements</h3>
            <div style="margin-top:15px">
                <input type="hidden" id="edit-feedback-id">
                <textarea id="improvement-content" placeholder="What should we change? (e.g., New maps, UI tweaks...)" style="height: 80px;"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:10px">
                <button onclick="closeImprovementModal()" style="flex:1; background:#444; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer">Close</button>
                <button id="save-improvement-btn" onclick="saveImprovement()" style="flex:1; background:var(--improvement-green); color:black; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer">Save Note</button>
            </div>
            <div id="feedback-list" class="feedback-list">
                <div style="text-align:center; color:#555; font-size:12px;">Loading feedback...</div>
            </div>
        </div>
    </div>

    <div id="logins-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--insight-blue)">Login History</h3>
            <div id="login-list" class="login-list">
                <div style="text-align:center; color:#555; font-size:12px;">Loading history...</div>
            </div>
            <div style="display:flex; margin-top:15px">
                <button onclick="document.getElementById('logins-modal').style.display='none'" style="flex:1; background:#444; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer">Close</button>
            </div>
        </div>
    </div>

    <div id="options-modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--options-pink)">More Options</h3>
            <div style="margin-top:20px; border: 1px solid #333; padding: 15px; border-radius: 8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:#ddd; white-space:nowrap;">Enable Subliminal LOGGO Flash</span>
                    <input type="checkbox" id="flash-toggle" onchange="toggleLoggoFlash()">
                </div>
                <div style="margin-top:10px; font-size:11px; color:#888; line-height:1.4;">
                    When enabled, the random LoggoMeter has a chance to trigger a ghostly "LOGGO" flash on screen whenever the meter hits 70% or higher.
                </div>
            </div>
            <div style="display:flex; margin-top:15px">
                <button onclick="document.getElementById('options-modal').style.display='none'" style="flex:1; background:#444; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer">Close</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xzqtltzfwddjqnnwxelw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3PXww4EzHZcU468PyBRDvw_rzny7xRZ';
        const EASTER_EGG_URL = 'https://raw.githubusercontent.com/bonzo19-ctrl/gabonzotan/refs/heads/main/choko.png'; 
        
        let supabaseClient, games = [], currentTab = 'history', currentUser = '';
        let eggClickCount = 0;
        let loggoFlashEnabled = false;

        function formatDate(dateStr) {
            if(!dateStr) return '??-??-????';
            const parts = dateStr.split('-');
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        }

        function triggerEasterEgg() {
            eggClickCount++;
            if (eggClickCount >= 6) {
                document.getElementById('egg-img').src = EASTER_EGG_URL;
                document.getElementById('easter-egg-overlay').style.display = 'flex';
                eggClickCount = 0;
            }
            setTimeout(() => eggClickCount = 0, 1000); 
        }

        window.checkSessionOnLoad = function() {
            // Load Settings
            const flashSetting = localStorage.getItem('gbt_flash_enabled');
            loggoFlashEnabled = (flashSetting === 'true');
            document.getElementById('flash-toggle').checked = loggoFlashEnabled;

            const savedUser = localStorage.getItem('gbt_user');
            const lastActive = localStorage.getItem('gbt_timestamp');
            const now = Date.now();
            if (savedUser && lastActive && (now - lastActive < 600000)) {
                currentUser = savedUser;
                updateSessionTimestamp();
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('active-user-tag').innerText = "User: " + currentUser;
                initSupabase();
            } else { logout(); }
        };

        function updateSessionTimestamp() { localStorage.setItem('gbt_timestamp', Date.now()); }

        window.checkPass = async function() {
            const rawUser = document.getElementById('user-name').value.trim().toLowerCase();
            const pass = document.getElementById('pass-input').value;
            if(rawUser !== "nico" && rawUser !== "gabo") { alert("User not recognized."); return; }
            if(pass === "bowwow") {
                currentUser = rawUser.charAt(0).toUpperCase() + rawUser.slice(1);
                localStorage.setItem('gbt_user', currentUser);
                updateSessionTimestamp();
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                document.getElementById('active-user-tag').innerText = "User: " + currentUser;
                initSupabase();
                try {
                    await supabaseClient.from('logins').insert([{ user_name: currentUser }]);
                } catch(e) { console.log("Login tracking failed (table might not exist)"); }
            } else { alert("Unauthorized."); }
        };

        window.logout = function() {
            localStorage.removeItem('gbt_user'); localStorage.removeItem('gbt_timestamp');
            document.getElementById('lock-screen').style.display = 'flex';
            document.getElementById('app-content').style.display = 'none';
        };

        function initSupabase() { supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); fetchGames(); }
        async function fetchGames() {
            const { data, error } = await supabaseClient.from('games')
                .select('*')
                .order('date', { ascending: false })
                .order('game_number', { ascending: false }); 
            if (!error) { games = data || []; render(); }
        }

        function render() {
            const view = document.getElementById('main-view');
            const actionArea = document.getElementById('action-area');
            view.innerHTML = '';
            actionArea.style.display = (currentTab === 'changelog' ? 'none' : 'block');

            if(currentTab === 'history') {
                if(games.length === 0) { view.innerHTML = '<p style="text-align:center; color:#555">Empty.</p>'; return; }
                let nWins = 0, gWins = 0;

                games.forEach(g => {
                    if(g.winner === 'Nico') nWins++;
                    if(g.winner === 'Gabo') gWins++;
                    const div = document.createElement('div');
                    div.className = `history-item ${g.winner === 'AI' ? 'ai-win-card' : ''}`;
                    const displayDate = formatDate(g.date);
                    const gameNumSuffix = ` #${g.game_number || 1}`;
                    const logDateRaw = g.logged_at ? new Date(g.logged_at) : null;
                    const logDateStr = logDateRaw ? `${String(logDateRaw.getDate()).padStart(2,'0')}-${String(logDateRaw.getMonth()+1).padStart(2,'0')}-${logDateRaw.getFullYear()}` : 'Legacy';
                    const loggedBy = g.logged_by || 'System';

                    div.innerHTML = `
                        <div class="actions">
                            <button class="action-btn edit-btn" onclick="editGame(${g.id})">‚úé</button>
                            <button class="action-btn del-btn" onclick="removeGame(${g.id})">&times;</button>
                        </div>
                        <div style="font-size:12px; color:var(--text-dim); margin-bottom:4px">${displayDate}${gameNumSuffix} ‚Ä¢ ${g.winningvp} VP</div>
                        ${g.map_used ? `<span class="map-info-label">${g.map_used}</span>` : ''}
                        <div>${g.players.map(p => `<span class="chip ${p===g.winner?'winner-chip':''}">${p}</span>`).join('')}</div>
                        ${g.notes ? `<div class="game-notes">${g.notes}</div>` : ''}
                        <div class="logged-meta">Logged by ${loggedBy} on ${logDateStr}</div>`;
                    view.appendChild(div);
                });
                
                if (nWins !== gWins) {
                    const h2h = document.createElement('div');
                    h2h.className = 'h2h-tracker';
                    if(nWins > gWins) h2h.innerText = 'Nico is currently leading Gabo';
                    else if(gWins > nWins) h2h.innerText = 'Gabo is currently leading Nico';
                    view.appendChild(h2h);
                }
            } else if (currentTab === 'insights') {
                const allPlayers = [...new Set(games.flatMap(g => g.players))].filter(p => p !== 'AI').sort();
                
                // --- PLAYER GRID START ---
                let gridHTML = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">';
                allPlayers.forEach(p => {
                    const wins = games.filter(g => g.winner === p);
                    
                    // Determine Color
                    let pColor = 'var(--accent-gold)';
                    if (p === 'Nico') pColor = 'var(--insight-blue)';
                    if (p === 'Gabo') pColor = 'var(--red)';

                    gridHTML += `<div style="background:var(--card-dark); padding:15px; border-radius:8px; text-align:center; border-bottom:3px solid ${pColor};">
                        <div style="font-weight:bold; color:${pColor}; text-transform:uppercase; font-size:16px; margin-bottom:5px;">${p}</div>
                        <div style="width:60px; height:60px; border:2px solid ${pColor}; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:20px; margin:10px auto; color:${pColor}; font-weight:bold;">${wins.length}</div>
                        <div style="font-size:9px; color:var(--text-dim)">Wins</div>
                    </div>`;
                });
                gridHTML += '</div>';
                // --- PLAYER GRID END ---

                // --- MAP META ANALYSIS START ---
                gridHTML += '<h3 style="color:var(--text-dim); margin-top:30px; margin-bottom:10px; text-align:center; text-transform:uppercase; letter-spacing:1px; font-size:12px;">Map Meta Analysis</h3><div style="display:grid; gap:10px;">';
                
                const uniqueMaps = [...new Set(games.map(g => g.map_used).filter(m => m))].sort();
                uniqueMaps.forEach(m => {
                    const mapGames = games.filter(g => g.map_used === m);
                    // Count winners
                    const winners = {};
                    mapGames.forEach(g => { winners[g.winner] = (winners[g.winner] || 0) + 1; });
                    
                    // Sort winners descending
                    const sortedWinners = Object.entries(winners).sort((a,b) => b[1] - a[1]);
                    const topWinner = sortedWinners.length > 0 ? sortedWinners[0][0] : null;

                    gridHTML += `<div style="background:var(--card-dark); padding:12px; border-radius:8px; border-left:3px solid #555;">
                        <div style="font-weight:bold; color:#eee; font-size:13px; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:5px;">${m} <span style="font-weight:normal; color:#666; font-size:10px;">(${mapGames.length} games)</span></div>
                        <div style="display:flex; flex-direction:column; gap:4px;">`;
                    
                    sortedWinners.forEach(([player, count]) => {
                        let pColor = '#aaa';
                        let rowStyle = "";
                        let crown = "";
                        
                        // Percentage
                        const pct = Math.round((count / mapGames.length) * 100);

                        if (player === 'Nico') pColor = 'var(--insight-blue)';
                        if (player === 'Gabo') pColor = 'var(--red)';
                        if (player === 'AI') pColor = 'var(--ai-purple)';
                        
                        if (player === topWinner) {
                            crown = " üëë";
                            rowStyle = "font-weight:bold; color:white;";
                        }

                        gridHTML += `<div style="font-size:11px; color:#ccc; display:flex; justify-content:space-between; ${rowStyle}">
                            <span><span style="color:${pColor}; font-weight:bold;">${player}</span>${crown}</span>
                            <span>${count} wins (${pct}%)</span>
                        </div>`;
                    });
                    
                    gridHTML += `</div></div>`;
                });
                gridHTML += '</div>';
                // --- MAP META ANALYSIS END ---

                view.innerHTML = gridHTML;

            } else if (currentTab === 'ai') {
                const aiGames = games.filter(g => g.aiplayed);
                const aiWins = aiGames.filter(g => g.winner === 'AI');
                view.innerHTML = `<div class="history-item ai-win-card" style="text-align:center">
                    <h2 style="color:var(--ai-purple)">AI Performance</h2>
                    <div style="width:80px; height:80px; border:2px solid var(--ai-purple); border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:28px; margin:20px auto; color:var(--ai-purple); font-weight:bold;">${aiWins.length}</div>
                    <p>Wins in ${aiGames.length} games</p>
                </div>`;
            } else if (currentTab === 'changelog') {
                view.innerHTML = `
                    <h2 style="color:var(--ai-purple); margin-top:0">Changeloggo</h2>
                    <div class="changelog-container">
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.19</div>
                            <ul class="changelog-list">
                                <li>Removed the "WIPE DATABASE" button from the footer.</li>
                                <li>Optimized footer layout: Remaining 5 buttons now have adequate space.</li>
                                <li>Ensured text wrapping works correctly for longer button labels like "CHANGELOGGO".</li>
                                <li>Forced "Enable Subliminal LOGGO Flash" option to display on a single line.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.18</div>
                            <ul class="changelog-list">
                                <li>Fixed footer button layout issue where text was overflowing.</li>
                                <li>Enabled multi-line text wrapping for footer buttons.</li>
                                <li>Added auto-centering for button text to support variable heights.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.17</div>
                            <ul class="changelog-list">
                                <li>Added "MORE OPTIONS" pink button to the footer.</li>
                                <li>Introduced togglable setting for the "Subliminal LOGGO Flash".</li>
                                <li>Flash feature is now disabled by default and persists via LocalStorage.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.16</div>
                            <ul class="changelog-list">
                                <li>Revised "Subliminal LOGGO Flash" to be more visible.</li>
                                <li>Changed transition logic to "Instant On, Slow Fade Off".</li>
                                <li>Increased opacity to 0.8 and duration to 200ms.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.15</div>
                            <ul class="changelog-list">
                                <li>Implemented the "Subliminal LOGGO Flash": A ghostly red "LOGGO" appears briefly when the meter hits 70%+.</li>
                                <li>Feature allows for passive chaos while using the app.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.14</div>
                            <ul class="changelog-list">
                                <li>Refined Map Meta Analysis with clearer vertical layout.</li>
                                <li>Added Crown (üëë) icon to highlight the map leader.</li>
                                <li>Included win percentages alongside raw win counts for better insight.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.13</div>
                            <ul class="changelog-list">
                                <li>Implemented Advanced "Map Meta" Analysis in Player Stats tab.</li>
                                <li>Updated Player Stats UI: Nico is now Blue, Gabo is Red.</li>
                                <li>Added breakdown of winners per map (games played, win counts).</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.12</div>
                            <ul class="changelog-list">
                                <li>Added blue "LOGINS" button to footer to view access history.</li>
                                <li>Implemented login tracking to "logins" database table.</li>
                                <li>Created modal to display list of user logins with timestamps.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.11</div>
                            <ul class="changelog-list">
                                <li>Implemented integer casting for IDs in delete operations to prevent type mismatch.</li>
                                <li>Added server-side row return check to confirm successful deletion.</li>
                                <li>Provided visual alerts for RLS permission errors on deletion.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.10</div>
                            <ul class="changelog-list">
                                <li>Implemented robust deletion fix: IDs are now passed as strings to prevent type coercion.</li>
                                <li>Added server-side return check: The app now verifies if a row was actually deleted by the database.</li>
                                <li>Added explicit alert feedback if a deletion appears successful but removes 0 items.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.9</div>
                            <ul class="changelog-list">
                                <li>Re-affirmed the strict requirement to keep the full, detailed changelog at all times.</li>
                                <li>Verified that the "Changeloggo" section remains a complete history without condensation.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.8</div>
                            <ul class="changelog-list">
                                <li>Reconfirmed commitment to code persistence.</li>
                                <li>Ensured no existing features or logic are removed during iterative updates.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.7</div>
                            <ul class="changelog-list">
                                <li>Full restoration of all previous changelog entries.</li>
                                <li>Ensured manual correction of condensation issue.</li>
                                <li>Stability check on feedback deletion functionality.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.6</div>
                            <ul class="changelog-list">
                                <li>Fixed critical bug preventing the deletion of improvement notes.</li>
                                <li>Added explicit database table targeting for feedback deletions.</li>
                                <li>Fixed scoping issues for the improvement 'X' button.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.5</div>
                            <ul class="changelog-list">
                                <li>Updated footer button labels to "WIPE DATABASE", "CHANGELOGGO", "IMPROVEMENTS", and "ABOUT".</li>
                                <li>Refined button alignment to sit immediately below the separator line.</li>
                                <li>Attempted fix for improvement deletion targeting.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.4</div>
                            <ul class="changelog-list">
                                <li>Aligned footer buttons horizontally for a sleeker look.</li>
                                <li>Added live feedback list to Improvements modal.</li>
                                <li>Implemented edit and delete permissions for the original author of improvements.</li>
                                <li>UX: Improvements window now remains open after saving/modifying notes.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.3</div>
                            <ul class="changelog-list">
                                <li>Added "IMPROVEMENTS" green button to the footer.</li>
                                <li>Implemented Improvements popup modal for user feedback.</li>
                                <li>Connected feedback submissions to Supabase "feedback" table.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.2</div>
                            <ul class="changelog-list">
                                <li>Implemented mandatory field validation for game creation and editing.</li>
                                <li>Added red asterisks to required fields (Map, Winner, Players, VP, Game #).</li>
                                <li>Added error prompts for missing data or invalid game conditions.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.1</div>
                            <ul class="changelog-list">
                                <li>Increased Easter Egg activation threshold to 6 clicks.</li>
                                <li>Removed the "Currently Tied" message from the Head-to-Head tracker.</li>
                                <li>Tightened UI layout by reducing various margins and padding for a denser look.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.8.0</div>
                            <ul class="changelog-list">
                                <li>Updated application asset URL to gabonzotan2.png for improved transparency and rendering.</li>
                                <li>Asset updated across both Password/Lock Screen and Main Dashboard.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.7.3</div>
                            <ul class="changelog-list">
                                <li>Implemented Game Number sorting to keep latest games at the top regardless of edits.</li>
                                <li>Added "#X" indicator for multiple games occurring on the same date.</li>
                                <li>Added 'game_number' input to the creation/edit modal.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.0.0 - v.1.7.2</div>
                            <ul class="changelog-list">
                                <li>Integrated Supabase for real-time cloud database synchronization.</li>
                                <li>Implemented AI Bot tracking and specialized win styling.</li>
                                <li>Added the "LOGGOMETER" calibrated to "LOGGO" status.</li>
                                <li>Developed Notes section for session details.</li>
                                <li>Established core UI with dark mode and gold accents.</li>
                            </ul>
                        </div>
                    </div>
                    <button class="back-nav-btn" onclick="switchTab('history')">‚Üê BACK TO GABONZOTAN</button>`;
            }
        }

        window.switchTab = (t) => { 
            updateSessionTimestamp(); 
            currentTab = t; 
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            const tabMap = { 'history': 't-history', 'insights': 't-insights', 'ai': 't-ai' };
            if (tabMap[t]) document.getElementById(tabMap[t]).classList.add('active');
            render(); 
        };

        window.openModal = function(isEdit = false) {
            updateSessionTimestamp();
            document.getElementById('modal').style.display = 'flex';
            if(!isEdit) {
                document.getElementById('editing-id').value = "";
                document.getElementById('game-date').valueAsDate = new Date();
                document.getElementById('winning-vp').value = 10;
                document.getElementById('game-number').value = 1;
                document.getElementById('game-map').value = "";
                document.getElementById('ai-toggle').checked = false;
                document.getElementById('game-notes').value = "";
                toggleAIRow();
            }
            const rows = document.getElementById('player-rows');
            rows.innerHTML = '';
            for(let i=1; i<=6; i++) {
                rows.innerHTML += `<div class="row-entry">
                    <select id="p${i}-sel" onchange="toggleGuestInput(${i})"><option value="">- Empty -</option><option value="Nico">Nico</option><option value="Gabo">Gabo</option><option value="Guest">Guest...</option></select>
                    <div class="guest-input-container"><input type="text" id="p${i}-name" placeholder="Guest Name" style="display:none"></div>
                    <div style="text-align:center"><input type="radio" name="winner" value="${i}"></div>
                </div>`;
            }
        };

        window.editGame = function(id) {
            updateSessionTimestamp();
            const game = games.find(g => g.id === id);
            openModal(true);
            document.getElementById('editing-id').value = id;
            document.getElementById('game-date').value = game.date;
            document.getElementById('winning-vp').value = game.winningvp;
            document.getElementById('game-number').value = game.game_number || 1;
            document.getElementById('game-map').value = game.map_used || "";
            document.getElementById('ai-toggle').checked = game.aiplayed;
            document.getElementById('game-notes').value = game.notes || "";
            toggleAIRow();
            if(game.winner === "AI") document.getElementById('ai-win-radio').checked = true;
            const players = game.players.filter(p => p !== "AI");
            for(let i=1; i<=6; i++) {
                const pName = players[i-1] || "";
                const sel = document.getElementById(`p${i}-sel`);
                if(pName === "Nico" || pName === "Gabo") sel.value = pName;
                else if (pName !== "") { sel.value = "Guest"; const gInput = document.getElementById(`p${i}-name`); gInput.style.display = 'block'; gInput.value = pName; }
                const winRadio = document.querySelector(`input[name="winner"][value="${i}"]`);
                if(game.winner === pName && pName !== "") winRadio.checked = true;
            }
        };

        window.saveGame = async function() {
            updateSessionTimestamp();
            const gameMap = document.getElementById('game-map').value;
            const gameVP = parseInt(document.getElementById('winning-vp').value);
            const gameNum = document.getElementById('game-number').value;
            const winnerRadio = document.querySelector('input[name="winner"]:checked');
            const isAIIncluded = document.getElementById('ai-toggle').checked;
            if(!gameMap) { alert("Please select a Map."); return; }
            if(!gameVP || gameVP <= 0) { alert("Winning VP must be greater than 0."); return; }
            if(!gameNum) { alert("Please enter a Game Number."); return; }
            const editId = document.getElementById('editing-id').value;
            const gameData = { 
                date: document.getElementById('game-date').value, winningvp: gameVP, game_number: parseInt(gameNum) || 1, map_used: gameMap, aiplayed: isAIIncluded, players: [], winner: "", notes: document.getElementById('game-notes').value.trim(), logged_by: currentUser, logged_at: new Date().toISOString()
            };
            for(let i=1; i<=6; i++) {
                const sel = document.getElementById(`p${i}-sel`).value;
                const finalName = sel === 'Guest' ? document.getElementById(`p${i}-name`).value.trim() : sel;
                if(finalName) { gameData.players.push(finalName); if(winnerRadio && winnerRadio.value == i) gameData.winner = finalName; }
            }
            if(isAIIncluded) { gameData.players.push("AI"); if(winnerRadio && winnerRadio.value === "AI") gameData.winner = "AI"; }
            if(gameData.players.length < 2) { alert("At least two players are required (AI counts)."); return; }
            if(!gameData.winner) { alert("Please select which player won the game."); return; }
            try {
                if(editId) { await supabaseClient.from('games').update(gameData).eq('id', editId); } 
                else { await supabaseClient.from('games').insert([gameData]); }
                closeModal(); fetchGames();
            } catch (err) { alert("DATABASE ERROR: " + err.message); }
        };

        window.openImprovementModal = () => {
            updateSessionTimestamp();
            document.getElementById('edit-feedback-id').value = "";
            document.getElementById('improvement-content').value = "";
            document.getElementById('improvement-modal').style.display = 'flex';
            fetchFeedback();
        };

        window.closeImprovementModal = () => {
            document.getElementById('improvement-modal').style.display = 'none';
        };

        async function fetchFeedback() {
            const list = document.getElementById('feedback-list');
            const { data, error } = await supabaseClient.from('feedback').select('*').order('created_at', { ascending: false });
            if(error) { list.innerHTML = `<div style="color:var(--red); font-size:10px;">Error: ${error.message}</div>`; return; }
            if(data.length === 0) { list.innerHTML = `<div style="text-align:center; color:#444; font-size:11px;">No feedback yet.</div>`; return; }
            list.innerHTML = data.map(f => {
                const isOwner = f.author === currentUser;
                const d = new Date(f.created_at);
                const ds = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
                const safeContent = f.content.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                return `
                <div class="feedback-card" id="card-${f.id}">
                    ${isOwner ? `
                    <div class="feedback-actions">
                        <span style="cursor:pointer; color:#666; font-size:12px;" onclick="editFeedback('${f.id}', '${safeContent}')">‚úé</span>
                        <span style="cursor:pointer; color:#666; font-size:12px;" onclick="deleteFeedback('${f.id}')">&times;</span>
                    </div>` : ''}
                    <div class="feedback-text">${f.content}</div>
                    <div class="feedback-meta">By ${f.author} ‚Ä¢ ${ds}</div>
                </div>`;
            }).join('');
        }

        window.saveImprovement = async () => {
            updateSessionTimestamp();
            const content = document.getElementById('improvement-content').value.trim();
            const editId = document.getElementById('edit-feedback-id').value;
            if(!content) { alert("Please enter a note."); return; }
            const btn = document.getElementById('save-improvement-btn');
            btn.disabled = true; btn.innerText = "Saving...";
            try {
                if(editId) { await supabaseClient.from('feedback').update({ content: content }).eq('id', editId); }
                else { await supabaseClient.from('feedback').insert([{ content: content, author: currentUser }]); }
                document.getElementById('improvement-content').value = "";
                document.getElementById('edit-feedback-id').value = "";
                btn.innerText = "Save Note";
                fetchFeedback();
            } catch (err) { alert("DB ERROR: " + err.message); } finally { btn.disabled = false; }
        };

        window.editFeedback = (id, content) => {
            document.getElementById('edit-feedback-id').value = id;
            document.getElementById('improvement-content').value = content;
            document.getElementById('improvement-content').focus();
        };

        window.deleteFeedback = async (id) => {
            if(!confirm("Delete this improvement?")) return;
            const card = document.getElementById(`card-${id}`);
            try {
                const { data, error } = await supabaseClient.from('feedback').delete().eq('id', parseInt(id)).select();
                if(error) throw error;
                if(data && data.length === 0) {
                    alert("Delete failed: Item not found or permission denied. Check Supabase RLS.");
                    if(card) card.style.borderLeft = "3px solid red";
                } else {
                    fetchFeedback();
                }
            } catch (err) { alert("DELETE ERROR: " + err.message); }
        };

        window.openLoginsModal = () => {
            updateSessionTimestamp();
            document.getElementById('logins-modal').style.display = 'flex';
            fetchLogins();
        };

        async function fetchLogins() {
            const list = document.getElementById('login-list');
            list.innerHTML = `<div style="text-align:center; color:#555; font-size:12px;">Loading history...</div>`;
            try {
                const { data, error } = await supabaseClient.from('logins').select('*').order('created_at', { ascending: false }).limit(50);
                if(error) throw error;
                if(data.length === 0) { list.innerHTML = `<div style="text-align:center; color:#444; font-size:11px;">No logins recorded yet.</div>`; return; }
                list.innerHTML = data.map(l => {
                    const d = new Date(l.created_at);
                    const ds = `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
                    return `<div class="login-card"><div class="login-user">${l.user_name}</div><div class="login-time">${ds}</div></div>`;
                }).join('');
            } catch(e) { list.innerHTML = `<div style="text-align:center; color:#red; font-size:11px;">Error loading logins (Table missing?).</div>`; }
        }

        // OPTIONS MENU LOGIC
        window.openOptionsModal = () => {
            updateSessionTimestamp();
            document.getElementById('options-modal').style.display = 'flex';
        };

        window.toggleLoggoFlash = () => {
            loggoFlashEnabled = document.getElementById('flash-toggle').checked;
            localStorage.setItem('gbt_flash_enabled', loggoFlashEnabled);
        };

        window.removeGame = async function(id) { 
            updateSessionTimestamp();
            if(confirm("Delete game?")) { await supabaseClient.from('games').delete().eq('id', id); fetchGames(); } 
        };

        window.toggleGuestInput = (idx) => { const sel = document.getElementById(`p${idx}-sel`).value; document.getElementById(`p${idx}-name`).style.display = (sel === 'Guest' ? 'block' : 'none'); };
        window.closeModal = () => document.getElementById('modal').style.display='none';
        window.toggleAIRow = () => document.getElementById('ai-row').style.display = document.getElementById('ai-toggle').checked ? 'grid' : 'none';

        setInterval(() => {
            const n = document.getElementById('needle');
            const r = Math.random() * 100;
            if(n) n.style.left = r + '%';
            const m = document.getElementById('meter-val');
            if(m) m.innerText = r.toFixed(1) + " % LOGGO";
            
            // SUBLIMINAL FLASH TRIGGER
            if (loggoFlashEnabled && r >= 70) {
                const flash = document.getElementById('loggo-flash');
                flash.style.transition = 'none'; // Instant ON
                flash.style.opacity = '0.8';
                setTimeout(() => {
                    flash.style.transition = 'opacity 0.5s ease-out'; // Slow OFF
                    flash.style.opacity = '0';
                }, 200); 
            }

            const lastActive = localStorage.getItem('gbt_timestamp');
            if(currentUser && lastActive && (Date.now() - lastActive > 600000)) { logout(); }
        }, 1500);
    </script>
</body>
</html>
