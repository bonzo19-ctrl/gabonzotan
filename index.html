<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaBonzoTan v.1.5.4</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: #121212; --card-dark: #1e1e1e; --accent-gold: #f1c40f;
            --ai-purple: #9b59b6; --text-dim: #b3b3b3; --insight-blue: #3498db; --red: #e74c3c;
        }
        body { background-color: var(--bg-dark); color: #ecf0f1; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; min-height: 100vh; overflow-x: hidden; }
        
        #lock-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        #lock-screen h1 { font-weight: 900; letter-spacing: 1px; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 5px; font-size: 1.5rem; white-space: nowrap; }
        #lock-screen .warning-msg { font-style: italic; color: #666; font-size: 13px; margin-bottom: 25px; }
        #lock-screen input { padding: 12px; border-radius: 5px; border: none; text-align: center; margin-bottom: 10px; background: #1a1a1a; color: white; border: 1px solid #333; width: 220px; font-size: 16px; }
        #lock-screen .version-tag { font-size: 10px; color: #888; margin-top: 30px; letter-spacing: 1px; font-weight: bold; }
        
        #app-content { width: 100%; max-width: 500px; padding: 40px 20px; display: none; position: relative; }
        h1 { text-align: center; font-weight: 900; letter-spacing: 4px; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 5px; font-size: 2.2rem; }
        .version-tag { text-align: center; font-size: 10px; color: #555; margin-bottom: 30px; letter-spacing: 1px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 13px; padding: 5px 10px; transition: 0.3s; white-space: nowrap; }
        .tab-btn.active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }

        .add-game-btn { width: 100%; background: var(--accent-gold); color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; font-size: 16px; }

        .history-item { background: var(--card-dark); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent-gold); position: relative; }
        .ai-win-card { border-left-color: var(--ai-purple); }
        .actions { position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; }
        .action-btn { background: none; border: none; color: #444; cursor: pointer; font-size: 16px; transition: color 0.2s; }
        .chip { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 13px; margin-right: 8px; border: 1px solid transparent; display: inline-block; margin-top: 8px; }
        .winner-chip { border-color: var(--accent-gold); color: var(--accent-gold); font-weight: bold; }
        
        .game-notes { font-size: 11px; color: #888; margin-top: 10px; font-style: italic; border-top: 1px solid #2a2a2a; padding-top: 8px; }

        .h2h-tracker { text-align: center; font-style: italic; color: var(--ai-purple); font-size: 14px; margin: 20px 0; padding: 10px; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .stat-card { background: var(--card-dark); padding: 15px; border-radius: 8px; text-align: center; border-bottom: 3px solid var(--insight-blue); }
        .stat-circle { width: 60px; height: 60px; border: 2px solid var(--insight-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; margin: 10px auto; color: var(--insight-blue); font-weight: bold; }
        
        .player-name-large { font-weight: bold; color: var(--insight-blue); text-transform: uppercase; font-size: 16px; margin-bottom: 5px; }
        .last-win-text { font-size: 9px; color: #777; margin-top: 5px; text-transform: uppercase; letter-spacing: 0.5px; font-weight: bold; }

        .app-footer { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 30px; padding-top: 20px; border-top: 1px solid #222; }
        .footer-btns { display: flex; flex-direction: column; gap: 8px; }
        .wipe-btn { background: #2a1111; color: var(--red); border: 1px solid var(--red); padding: 8px 12px; border-radius: 6px; font-size: 9px; cursor: pointer; letter-spacing: 1px; width: 120px; }
        .changelog-btn { background: #1e112a; color: var(--ai-purple); border: 1px solid var(--ai-purple); padding: 8px 12px; border-radius: 6px; font-size: 9px; cursor: pointer; letter-spacing: 1px; width: 120px; text-transform: uppercase; }

        .loggometer { width: 110px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; cursor: pointer; }
        .meter-dial { height: 8px; background: #222; border-radius: 5px; position: relative; overflow: hidden; margin: 5px 0; }
        .meter-needle { position: absolute; height: 100%; width: 4px; background: var(--accent-gold); left: 0%; transition: left 0.3s ease; }

        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 95%; max-width: 420px; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        .row-entry { display: grid; grid-template-columns: 100px 1fr 40px; gap: 10px; margin-bottom: 12px; align-items: center; }
        select, input, textarea { background: #333; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; font-size: 14px; }
        textarea { resize: vertical; min-height: 60px; font-family: inherit; }
        
        .changelog-container { max-height: 480px; overflow-y: auto; padding-right: 10px; margin-bottom: 20px; scrollbar-width: thin; scrollbar-color: var(--ai-purple) #111; }
        .changelog-entry { margin-bottom: 25px; padding-left: 10px; border-left: 2px solid #333; }
        .changelog-ver { color: var(--accent-gold); font-weight: bold; font-size: 14px; margin-bottom: 5px; }
        .changelog-list { list-style: none; padding: 0; margin: 0; font-size: 12px; color: var(--text-dim); }
        .changelog-list li { margin-bottom: 6px; position: relative; padding-left: 12px; line-height: 1.4; }
        .changelog-list li::before { content: "•"; position: absolute; left: 0; color: var(--insight-blue); }
        .back-nav-btn { width: auto; background: #1e112a; color: var(--ai-purple); border: 1px solid var(--ai-purple); padding: 8px 15px; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 11px; letter-spacing: 1px; display: block; margin: 0 auto; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h1>WELCOME TO GABONZOTAN</h1>
        <div class="warning-msg">(If you're not Gabo or Nico, get the fuck out of here.)</div>
        <input type="password" id="pass-input" placeholder="Password" onkeydown="if(event.key==='Enter') checkPass()">
        <button onclick="checkPass()" style="padding:10px 20px; background:var(--accent-gold); border:none; border-radius:4px; font-weight:bold; cursor:pointer">ENTER</button>
        <div class="version-tag">STABLE RELEASE v.1.5.4</div>
    </div>

    <div id="app-content">
        <h1>GaBonzoTan</h1>
        <div class="version-tag">STABLE RELEASE v.1.5.4</div>
        
        <div class="nav-tabs">
            <button id="t-history" class="tab-btn active" onclick="switchTab('history')">Game History</button>
            <button id="t-insights" class="tab-btn" onclick="switchTab('insights')">Player Stats</button>
            <button id="t-ai" class="tab-btn" onclick="switchTab('ai')">AI Stats</button>
        </div>

        <div id="action-area"><button class="add-game-btn" onclick="openModal()">+ ADD NEW GAME</button></div>
        <div id="main-view">Connecting...</div>

        <div class="app-footer">
            <div class="footer-btns">
                <button class="wipe-btn" onclick="alert('Nice try!')">WIPE DATABASE</button>
                <button class="changelog-btn" onclick="switchTab('changelog')">CHANGELOGGO</button>
            </div>
            <div class="loggometer" onclick="alert('RAAAAAAAR')">
                <div style="font-size:8px; color:#666; text-align:center">LOGGOMETER™</div>
                <div class="meter-dial"><div id="needle" class="meter-needle"></div></div>
                <div id="meter-val" style="font-size:9px; color:#aaa; text-align:center; font-family:monospace">0.0% LOGGO</div>
            </div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="margin-top:0; color:var(--accent-gold)">Add A Game</h3>
            <input type="hidden" id="editing-id">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px">
                <input type="date" id="game-date">
                <input type="number" id="winning-vp" placeholder="VP" value="10">
            </div>
            <div id="player-rows"></div>
            <div style="display:grid; grid-template-columns:1fr 40px; gap:10px; align-items:center; margin-top:10px">
                <span style="font-size: 13px; color: var(--text-dim);">Include AI Player</span>
                <input type="checkbox" id="ai-toggle" onchange="toggleAIRow()">
            </div>
            <div id="ai-row" class="row-entry" style="display:none; margin-top:10px; color:var(--ai-purple)">
                <span style="font-weight:bold">AI Bot</span><span></span><input type="radio" name="winner" id="ai-win-radio" value="AI">
            </div>
            <div style="margin-top:15px">
                <textarea id="game-notes" placeholder="Notes (optional session details...)"></textarea>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button onclick="closeModal()" style="flex:1; background:#444; color:white; border:none; padding:12px; border-radius:4px; cursor:pointer">Cancel</button>
                <button onclick="saveGame()" style="flex:1; background:var(--accent-gold); color:black; border:none; padding:12px; border-radius:4px; font-weight:bold; cursor:pointer">Save Changes</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xzqtltzfwddjqnnwxelw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3PXww4EzHZcU468PyBRDvw_rzny7xRZ';
        let supabaseClient, games = [], currentTab = 'history';

        window.checkPass = function() {
            if(document.getElementById('pass-input').value === "bowwow") {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.display = 'block';
                initSupabase();
            } else { alert("Unauthorized."); }
        };

        function initSupabase() { supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY); fetchGames(); }
        async function fetchGames() {
            const { data, error } = await supabaseClient.from('games').select('*').order('date', { ascending: false });
            if (!error) { games = data || []; render(); }
        }

        function render() {
            const view = document.getElementById('main-view');
            const actionArea = document.getElementById('action-area');
            view.innerHTML = '';
            actionArea.style.display = (currentTab === 'changelog' ? 'none' : 'block');

            if(currentTab === 'history') {
                if(games.length === 0) { view.innerHTML = '<p style="text-align:center; color:#555">Empty.</p>'; return; }
                let nWins = 0, gWins = 0;
                games.forEach(g => {
                    if(g.winner === 'Nico') nWins++;
                    if(g.winner === 'Gabo') gWins++;
                    const div = document.createElement('div');
                    div.className = `history-item ${g.winner === 'AI' ? 'ai-win-card' : ''}`;
                    div.innerHTML = `
                        <div class="actions">
                            <button class="action-btn edit-btn" onclick="editGame(${g.id})">✎</button>
                            <button class="action-btn del-btn" onclick="removeGame(${g.id})">&times;</button>
                        </div>
                        <div style="font-size:12px; color:var(--text-dim); margin-bottom:8px">${g.date} • ${g.winningvp} VP</div>
                        <div>${g.players.map(p => `<span class="chip ${p===g.winner?'winner-chip':''}">${p}</span>`).join('')}</div>
                        ${g.notes ? `<div class="game-notes">${g.notes}</div>` : ''}`;
                    view.appendChild(div);
                });
                const h2h = document.createElement('div');
                h2h.className = 'h2h-tracker';
                if(nWins > gWins) h2h.innerText = 'Nico is currently leading Gabo';
                else if(gWins > nWins) h2h.innerText = 'Gabo is currently leading Nico';
                else h2h.innerText = 'Nico and Gabo are currently tied';
                view.appendChild(h2h);

            } else if (currentTab === 'insights') {
                const allPlayers = [...new Set(games.flatMap(g => g.players))].filter(p => p !== 'AI').sort();
                let gridHTML = '<div class="stat-grid">';
                allPlayers.forEach(p => {
                    const wins = games.filter(g => g.winner === p);
                    const lastWin = wins.length > 0 ? wins[0].date : "Never";
                    gridHTML += `<div class="stat-card">
                        <div class="player-name-large">${p}</div>
                        <div class="stat-circle">${wins.length}</div>
                        <div style="font-size:9px; color:var(--text-dim)">Wins</div>
                        <div class="last-win-text">Last win: ${lastWin}</div>
                    </div>`;
                });
                view.innerHTML = gridHTML + '</div>';
            } else if (currentTab === 'ai') {
                const aiGames = games.filter(g => g.aiplayed);
                const aiWins = aiGames.filter(g => g.winner === 'AI');
                const lastAiWin = aiWins.length > 0 ? aiWins[0].date : "Never";
                view.innerHTML = `<div class="history-item ai-win-card" style="text-align:center">
                    <h2 style="color:var(--ai-purple)">AI Performance</h2>
                    <div class="stat-circle" style="border-color:var(--ai-purple); color:var(--ai-purple); height:80px; width:80px; font-size:28px">${aiWins.length}</div>
                    <p>Wins in ${aiGames.length} games</p>
                    <div class="last-win-text">Last takeover: ${lastAiWin}</div>
                </div>`;
            } else if (currentTab === 'changelog') {
                view.innerHTML = `
                    <h2 style="color:var(--ai-purple); margin-top:0">Changeloggo</h2>
                    <div class="changelog-container">
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.5.4</div>
                            <ul class="changelog-list">
                                <li>Expanded detailed history to include all legacy version milestones.</li>
                                <li>Added left arrow to "BACK TO GABONZOTAN" button.</li>
                                <li>Changed footer button to all-caps "CHANGELOGGO".</li>
                                <li>Updated modal header from "Record New Session" to "Add A Game".</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.5.3</div>
                            <ul class="changelog-list">
                                <li>Added free-text Notes section to game recording (supports history & new entries).</li>
                                <li>Renamed "Full Project History" to "Changeloggo".</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.5.2</div>
                            <ul class="changelog-list">
                                <li>Reconstructed detailed history in Changelog.</li>
                                <li>Added scrollable container for long logs.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.5.1</div>
                            <ul class="changelog-list">
                                <li>Removed Total VP counter from Stat cards.</li>
                                <li>Refined spacing in the Player Insights grid.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.5.0</div>
                            <ul class="changelog-list">
                                <li>Introduced "Total VP Accumulated" tracking (deprecated in v.1.5.1).</li>
                                <li>Optimized render logic for multi-tab stats.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.4.9</div>
                            <ul class="changelog-list">
                                <li>Lock Screen Update: Greeting changed to single-line "WELCOME TO GABONZOTAN".</li>
                                <li>UI Update: Player names in Insights enlarged.</li>
                                <li>UI Update: Bolded entire "Last Win" text string.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.4.8</div>
                            <ul class="changelog-list">
                                <li>Added "Last Win" date tracking for Nico and Gabo.</li>
                                <li>Added "Last Takeover" date tracking for the AI player.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.4.7</div>
                            <ul class="changelog-list">
                                <li>Added Nico vs Gabo Head-to-Head winner status logic.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.4.6</div>
                            <ul class="changelog-list">
                                <li>Implemented guest player entry system for 3-6 player games.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.4.0</div>
                            <ul class="changelog-list">
                                <li>Introduced the LoggoMeter™ with real-time "LOGGO" needle calibration.</li>
                                <li>Added specialized AI Stats tab to track bot win rates.</li>
                            </ul>
                        </div>
                        <div class="changelog-entry">
                            <div class="changelog-ver">v.1.0.0</div>
                            <ul class="changelog-list">
                                <li>Initial Stable Build.</li>
                                <li>Supabase Cloud Database integration.</li>
                                <li>Password-protected entry system.</li>
                                <li>Core CRUD operations for game history.</li>
                            </ul>
                        </div>
                    </div>
                    <button class="back-nav-btn" onclick="switchTab('history')">← BACK TO GABONZOTAN</button>
                `;
            }
        }

        window.switchTab = (t) => { currentTab = t; document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id.includes(t))); window.scrollTo(0,0); render(); };
        window.openModal = function(isEdit = false) {
            document.getElementById('modal').style.display = 'flex';
            if(!isEdit) {
                document.getElementById('editing-id').value = "";
                document.getElementById('game-date').valueAsDate = new Date();
                document.getElementById('winning-vp').value = 10;
                document.getElementById('ai-toggle').checked = false;
                document.getElementById('game-notes').value = "";
                toggleAIRow();
            }
            const rows = document.getElementById('player-rows');
            rows.innerHTML = '';
            for(let i=1; i<=6; i++) {
                rows.innerHTML += `<div class="row-entry">
                    <select id="p${i}-sel" onchange="toggleGuestInput(${i})"><option value="">- Empty -</option><option value="Nico">Nico</option><option value="Gabo">Gabo</option><option value="Guest">Guest...</option></select>
                    <div class="guest-input-container"><input type="text" id="p${i}-name" placeholder="Guest Name" style="display:none"></div>
                    <input type="radio" name="winner" value="${i}">
                </div>`;
            }
        };
        window.editGame = function(id) {
            const game = games.find(g => g.id === id);
            openModal(true);
            document.getElementById('editing-id').value = id;
            document.getElementById('game-date').value = game.date;
            document.getElementById('winning-vp').value = game.winningvp;
            document.getElementById('ai-toggle').checked = game.aiplayed;
            document.getElementById('game-notes').value = game.notes || "";
            toggleAIRow();
            if(game.winner === "AI") document.getElementById('ai-win-radio').checked = true;
            const players = game.players.filter(p => p !== "AI");
            for(let i=1; i<=6; i++) {
                const pName = players[i-1] || "";
                const sel = document.getElementById(`p${i}-sel`);
                if(pName === "Nico" || pName === "Gabo") sel.value = pName;
                else if (pName !== "") { sel.value = "Guest"; const gInput = document.getElementById(`p${i}-name`); gInput.style.display = 'block'; gInput.value = pName; }
                const winRadio = document.querySelector(`input[name="winner"][value="${i}"]`);
                if(game.winner === pName && pName !== "") winRadio.checked = true;
            }
        };
        window.saveGame = async function() {
            const winnerRadio = document.querySelector('input[name="winner"]:checked');
            if(!winnerRadio) { alert("Select a winner!"); return; }
            const editId = document.getElementById('editing-id').value;
            const gameData = { 
                date: document.getElementById('game-date').value, 
                winningvp: parseInt(document.getElementById('winning-vp').value) || 0, 
                aiplayed: document.getElementById('ai-toggle').checked, 
                players: [], 
                winner: "",
                notes: document.getElementById('game-notes').value.trim()
            };
            for(let i=1; i<=6; i++) {
                const sel = document.getElementById(`p${i}-sel`).value;
                const finalName = sel === 'Guest' ? document.getElementById(`p${i}-name`).value : sel;
                if(finalName) { gameData.players.push(finalName); if(winnerRadio.value == i) gameData.winner = finalName; }
            }
            if(gameData.aiplayed) { gameData.players.push("AI"); if(winnerRadio.value === "AI") gameData.winner = "AI"; }
            if(editId) await supabaseClient.from('games').update(gameData).eq('id', editId);
            else await supabaseClient.from('games').insert([gameData]);
            closeModal(); fetchGames();
        };
        window.removeGame = async function(id) { if(confirm("Delete game?")) { await supabaseClient.from('games').delete().eq('id', id); fetchGames(); } };
        window.toggleGuestInput = (idx) => { const sel = document.getElementById(`p${idx}-sel`).value; document.getElementById(`p${idx}-name`).style.display = (sel === 'Guest' ? 'block' : 'none'); };
        window.closeModal = () => document.getElementById('modal').style.display='none';
        window.toggleAIRow = () => document.getElementById('ai-row').style.display = document.getElementById('ai-toggle').checked ? 'grid' : 'none';

        setInterval(() => {
            const n = document.getElementById('needle');
            const r = Math.random() * 100;
            if(n) n.style.left = r + '%';
            document.getElementById('meter-val').innerText = r.toFixed(1) + " % LOGGO";
        }, 1500);
    </script>
</body>
</html>
