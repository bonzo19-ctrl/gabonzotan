<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GaBonzoTan v.1.2.8</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-dark: #121212; --card-dark: #1e1e1e; --accent-gold: #f1c40f;
            --ai-purple: #9b59b6; --text-dim: #b3b3b3; --insight-blue: #3498db; --red: #e74c3c;
        }
        body { background-color: var(--bg-dark); color: #ecf0f1; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; justify-content: center; min-height: 100vh; }
        
        #lock-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        #lock-screen input { padding: 12px; border-radius: 5px; border: none; text-align: center; margin-bottom: 10px; background: #222; color: white; border: 1px solid #444; width: 200px; }
        
        #app-content { width: 100%; max-width: 600px; padding: 40px 20px; filter: blur(10px); transition: filter 0.5s ease; }
        
        h1 { text-align: center; font-weight: 300; letter-spacing: 4px; color: var(--accent-gold); text-transform: uppercase; margin-bottom: 30px; }
        
        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: var(--text-dim); cursor: pointer; font-size: 14px; padding: 5px 15px; transition: 0.3s; }
        .tab-btn.active { color: var(--accent-gold); border-bottom: 2px solid var(--accent-gold); }

        .add-game-btn { width: 100%; background: var(--accent-gold); color: black; border: none; padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 20px; font-size: 16px; }

        .history-item { background: var(--card-dark); border-radius: 8px; padding: 15px; margin-bottom: 12px; border-left: 4px solid var(--accent-gold); position: relative; }
        .ai-win-card { border-left-color: var(--ai-purple); }
        
        .del-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; color: #444; cursor: pointer; font-size: 18px; }
        .del-btn:hover { color: var(--red); }

        .chip { background: #333; padding: 4px 10px; border-radius: 20px; font-size: 13px; margin-right: 5px; border: 1px solid transparent; display: inline-block; margin-top: 5px; }
        .winner-chip { border-color: var(--accent-gold); color: var(--accent-gold); font-weight: bold; }

        .stat-circle { width: 80px; height: 80px; border: 3px solid var(--insight-blue); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; margin: 15px auto; color: var(--insight-blue); font-weight: bold; }

        /* LOGGOMETER (PROTECTED) */
        .loggometer { position: fixed; bottom: 20px; right: 20px; width: 120px; background: #111; padding: 10px; border-radius: 8px; border: 1px solid #333; }
        .meter-dial { height: 10px; background: #222; border-radius: 5px; position: relative; overflow: hidden; margin: 5px 0; }
        .meter-needle { position: absolute; height: 100%; width: 4px; background: var(--accent-gold); left: 0%; transition: left 0.3s ease; }

        /* MODAL */
        #modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1e1e1e; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; border: 1px solid #333; }
        .row-entry { display: grid; grid-template-columns: 1.5fr 1.5fr 40px; gap: 8px; margin-bottom: 10px; align-items: center; }
        select, input { background: #333; color: white; border: 1px solid #444; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        input[type="radio"], input[type="checkbox"] { width: auto; }
    </style>
</head>
<body>

    <div id="lock-screen">
        <h2 style="color:var(--accent-gold); font-weight:300; letter-spacing:2px">ACCESS REQUIRED</h2>
        <input type="password" id="pass-input" placeholder="Password">
        <button onclick="checkPass()" style="padding:10px 20px; background:var(--accent-gold); border:none; border-radius:4px; font-weight:bold; cursor:pointer">ENTER</button>
    </div>

    <div id="app-content">
        <h1>GaBonzoTan</h1>
        
        <div class="nav-tabs">
            <button id="t-history" class="tab-btn active" onclick="switchTab('history')">History</button>
            <button id="t-insights" class="tab-btn" onclick="switchTab('insights')">Insights</button>
            <button id="t-ai" class="tab-btn" onclick="switchTab('ai')">AI System</button>
        </div>

        <button class="add-game-btn" onclick="openModal()">+ ADD NEW GAME</button>
        <div id="main-view">Connecting to Cloud...</div>

        <div class="loggometer">
            <div style="font-size:9px; color:#666; text-align:center">LOGGOMETER™</div>
            <div class="meter-dial"><div id="needle" class="meter-needle"></div></div>
            <div id="meter-val" style="font-size:10px; color:#aaa; text-align:center; font-family:monospace">0.0% LOGGO</div>
        </div>
    </div>

    <div id="modal">
        <div class="modal-content">
            <h3 style="margin-top:0; color:var(--accent-gold)">Record Session</h3>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px">
                <input type="date" id="game-date">
                <input type="number" id="winning-vp" placeholder="VP">
            </div>
            <div id="player-rows"></div>
            <div style="margin-top:10px; font-size:14px">
                <input type="checkbox" id="ai-toggle" onchange="toggleAIRow()"> Include AI Player
            </div>
            <div id="ai-row" class="row-entry" style="display:none; margin-top:10px; color:var(--ai-purple)">
                <span style="font-weight:bold">AI Bot</span><span></span><input type="radio" name="winner" value="AI">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px">
                <button onclick="closeModal()" style="flex:1; background:#444; color:white; border:none; padding:10px; border-radius:4px; cursor:pointer">Cancel</button>
                <button onclick="saveGame()" style="flex:1; background:var(--accent-gold); color:black; border:none; padding:10px; border-radius:4px; font-weight:bold; cursor:pointer">Save Game</button>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://xzqtltzfwddjqnnwxelw.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_3PXww4EzHZcU468PyBRDvw_rzny7xRZ';

        let supabaseClient;
        let games = [];
        let currentTab = 'history';

        window.checkPass = function() {
            const pass = document.getElementById('pass-input').value;
            if(pass === "bowwow") {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('app-content').style.filter = 'none';
                initSupabase();
            } else {
                alert("Unauthorized Access.");
            }
        };

        function initSupabase() {
            try {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                fetchGames();
            } catch (err) {
                console.error("Supabase Init Error:", err);
                document.getElementById('main-view').innerText = "Library Load Error.";
            }
        }

        async function fetchGames() {
            const { data, error } = await supabaseClient.from('games').select('*').order('date', { ascending: false });
            if (!error) { 
                games = data || []; 
                render(); 
            } else { 
                document.getElementById('main-view').innerText = "Database Connection Error.";
                console.error("Fetch Error:", error);
            }
        }

        window.saveGame = async function() {
            const winnerRadio = document.querySelector('input[name="winner"]:checked');
            if(!winnerRadio) { alert("Select a winner!"); return; }

            const newGame = {
                date: document.getElementById('game-date').value,
                winningvp: parseInt(document.getElementById('winning-vp').value) || 0,
                aiplayed: document.getElementById('ai-toggle').checked,
                players: [],
                winner: ""
            };

            for(let i=1; i<=4; i++) {
                const sel = document.getElementById(`p${i}-sel`).value;
                const guestName = document.getElementById(`p${i}-name`).value;
                const finalName = sel === 'Guest' ? guestName : sel;
                if(finalName) {
                    newGame.players.push(finalName);
                    if(winnerRadio.value == i) newGame.winner = finalName;
                }
            }
            if(newGame.aiplayed) {
                newGame.players.push("AI");
                if(winnerRadio.value === "AI") newGame.winner = "AI";
            }

            const { error } = await supabaseClient.from('games').insert([newGame]);
            if(!error) { closeModal(); fetchGames(); } else { console.error(error); alert("Error saving to cloud."); }
        };

        window.removeGame = async function(id) {
            if(confirm("Permanently delete this game?")) {
                await supabaseClient.from('games').delete().eq('id', id);
                fetchGames();
            }
        };

        function render() {
            const view = document.getElementById('main-view');
            view.innerHTML = '';
            
            if(currentTab === 'history') {
                if(games.length === 0) { view.innerHTML = '<p style="text-align:center; color:#666">No games found.</p>'; }
                games.forEach(g => {
                    const div = document.createElement('div');
                    div.className = `history-item ${g.winner === 'AI' ? 'ai-win-card' : ''}`;
                    div.innerHTML = `
                        <button class="del-btn" onclick="removeGame(${g.id})">&times;</button>
                        <div style="font-size:12px; color:var(--text-dim); margin-bottom:8px">${g.date} • ${g.winningvp} VP</div>
                        <div>${g.players.map(p => `<span class="chip ${p===g.winner?'winner-chip':''}">${p}</span>`).join('')}</div>
                    `;
                    view.appendChild(div);
                });
            } else if (currentTab === 'insights') {
                const allPlayers = [...new Set(games.flatMap(g => g.players))].sort();
                if(allPlayers.length === 0) { view.innerHTML = '<p style="text-align:center">No data for insights.</p>'; return; }
                
                view.innerHTML = `<select id="ins-p" onchange="renderPlayerStats()" style="width:100%; margin-bottom:20px">
                    ${allPlayers.map(p => `<option value="${p}">${p}</option>`).join('')}
                </select><div id="ins-result"></div>`;
                renderPlayerStats();
            } else if (currentTab === 'ai') {
                const aiGames = games.filter(g => g.aiplayed);
                const aiWins = aiGames.filter(g => g.winner === 'AI').length;
                const rate = aiGames.length > 0 ? ((aiWins / aiGames.length) * 100).toFixed(1) : 0;
                view.innerHTML = `
                    <div class="history-item ai-win-card" style="text-align:center">
                        <h2 style="color:var(--ai-purple); margin:0">AI System Stats</h2>
                        <div style="font-size:40px; margin:10px 0">${aiWins} / ${aiGames.length}</div>
                        <p>Total Wins / Total Participation</p>
                        <div style="font-size:20px; color:var(--accent-gold)">Efficiency: ${rate}%</div>
                    </div>`;
            }
        }

        window.renderPlayerStats = function() {
            const p = document.getElementById('ins-p').value;
            const pGames = games.filter(g => g.players.includes(p));
            const wins = pGames.filter(g => g.winner === p).length;
            document.getElementById('ins-result').innerHTML = `
                <div class="history-item" style="text-align:center">
                    <h2 style="color:var(--insight-blue); margin:0">${p}</h2>
                    <div class="stat-circle">${wins}</div>
                    <p>Wins in ${pGames.length} games</p>
                </div>`;
        }

        window.openModal = function() {
            document.getElementById('modal').style.display = 'flex';
            document.getElementById('game-date').valueAsDate = new Date();
            const rows = document.getElementById('player-rows');
            rows.innerHTML = '';
            for(let i=1; i<=4; i++) {
                rows.innerHTML += `
                    <div class="row-entry">
                        <select id="p${i}-sel" onchange="document.getElementById('p${i}-name').style.display=(this.value=='Guest'?'block':'none')">
                            <option value="">- Empty -</option><option value="Nico">Nico</option><option value="Gabo">Gabo</option><option value="Guest">Guest...</option>
                        </select>
                        <input type="text" id="p${i}-name" placeholder="Guest Name" style="display:none">
                        <div></div><input type="radio" name="winner" value="${i}">
                    </div>`;
            }
        }
        window.closeModal = function() { document.getElementById('modal').style.display='none'; }
        window.toggleAIRow = function() { document.getElementById('ai-row').style.display = document.getElementById('ai-toggle').checked ? 'grid' : 'none'; }
        window.switchTab = function(t) { 
            currentTab = t; 
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.toggle('active', b.id.includes(t)));
            render(); 
        }

        setInterval(() => {
            const n = document.getElementById('needle');
            const v = document.getElementById('meter-val');
            const r = Math.random() * 100;
            if(n) n.style.left = r + '%';
            if(v) v.innerText = r.toFixed(1) + "% LOGGO";
        }, 1500);
    </script>
</body>
</html>
